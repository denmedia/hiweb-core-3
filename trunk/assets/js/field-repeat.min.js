String.prototype.escapeRegExp=function(){return this.toString().replace(/[\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")};var hiweb_field_repeat={selector:".hiweb-field-repeat",selector_source:"[data-row-source]",selector_wrap:"tbody.wrap",selector_row:"[data-row]",selector_button_add:"[data-action-add]",selector_button_clear:"[data-action-clear]",selector_button_remove:"[data-action-remove]",selector_button_duplicate:"[data-action-duplicate]",init:function(){hiweb_field_repeat.make_sortable();jQuery(hiweb_field_repeat.selector+" .dropdown").dropdown({action:"hide"})},init_once:function(){jQuery("body").on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_add,hiweb_field_repeat.click_add).on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_remove,hiweb_field_repeat.click_remove).on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_duplicate,hiweb_field_repeat.click_duplicate).on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_clear,hiweb_field_repeat.click_clear_full);hiweb_field_repeat.init()},get_row_source:function(a){return jQuery(a).find("> table > tbody[data-rows-source] > tr[data-row]")},get_rows_list:function(a){return jQuery(a).find("> table > tbody[data-rows-list]")},get_rows:function(a){return jQuery(a).find("> table > tbody[data-rows-list] > tr[data-row]")},get_cols:function(a){return jQuery(a).find("> table > thead [data-col]")},get_cols_by_row:function(a){return a.find("> [data-col], > .flex-column > .hiweb-field-repeat-flex > tbody > tr > td > [data-col]")},make_sortable:function(){var a=hiweb_field_repeat.get_rows_list(hiweb_field_repeat.selector);if(typeof a.sortable=="undefined"){alert("Плагин jquery.ui.sortable.js не подключен!");return}if(a.sortable.hasOwnProperty("destroy")){a.sortable("destroy")}a.sortable({update:function(c,b){hiweb_field_repeat.make_table_names(jQuery(this).closest(hiweb_field_repeat.selector));b.placeholder.find("> [data-col] > *").trigger("drag_update")},distance:3,handle:"> [data-drag], > [data-drag] button, > [data-drag] i",helper:function(c,b){b.find("th, td").each(function(){jQuery(this).width(jQuery(this).width())});b.find("> [data-col] > *").trigger("dragged");return b},revert:true,start:function(c,b){b.placeholder.height(b.helper.height());b.helper.find("> [data-col] > *").trigger("drag_start",b)},stop:function(c,b){b.item.find("[data-col] > *, .flex-column > .hiweb-field-repeat-flex > tbody > tr > [data-col] > *").trigger("drag_stop",b.placeholder)}})},make_table_names:function(a){a=jQuery(a);var c=a.attr("name");var b=0;hiweb_field_repeat.get_rows(a).each(function(){var d=jQuery(this).attr("data-row",b);hiweb_field_repeat.get_cols_by_row(d).each(function(){var f=jQuery(this).attr("data-col");var e=c+"["+b+"]["+f+"]";jQuery(this).find("[name]").each(function(){var h=jQuery(this);var i="^"+c.escapeRegExp()+"\\[(\\s{1}|\\\d+)\\]\\["+f+"\\]";var g=h.attr("name").replace(new RegExp(i,"i"),e);h.attr("name",g)})});b++});a.find("> table > tbody[data-rows-message] [data-row-empty]").attr("data-row-empty",b>0?"1":"0");hiweb_field_repeat.make_sortable()},get_global_id:function(a){return jQuery(a).is("[data-global-id]")?jQuery(a).attr("data-global-id"):jQuery(a).closest("[data-global-id]").attr("data-global-id")},get_name_id:function(a){return jQuery(a).is("[data-input-name]")?jQuery(a).attr("name"):jQuery(a).closest("[data-input-name]").attr("name")},click_add:function(f){f.preventDefault();if(jQuery(this).is('[data-action-add="flex-dropdown"]')){var g=jQuery(this).closest("[data-ctrl]").find("[data-sub-flex-dropdown]");var d=null;g.fadeIn().off("mouseover mouseout").on("mouseout",function(){d=setTimeout(function(){g.fadeOut()},1000)}).on("mouseover",function(){clearTimeout(d)})}else{var c=jQuery(this).is('[data-action-add="1"]');var b=jQuery(this).closest(hiweb_field_repeat.selector);var a=jQuery(this).is("[data-flex-id]")?jQuery(this).attr("data-flex-id"):"";if(a!==""){jQuery(this).closest("[data-sub-flex-dropdown]").fadeOut()}hiweb_field_repeat.add_rows(b,c,1,"",a)}},add_rows:function(c,d,b,g,a){if(typeof b==="undefined"){b=1}if(typeof d==="undefined"){d=false}if(typeof a==="undefined"){a=""}var f=hiweb_field_repeat.get_rows_list(c);var e=d?0:hiweb_field_repeat.get_rows(c).length;jQuery.ajax({url:ajaxurl+"?action=hiweb-field-repeat-get-row",type:"post",data:{id:hiweb_field_repeat.get_global_id(c),method:"ajax_html_row",input_name:hiweb_field_repeat.get_name_id(c),index:e,flex_row_id:a},dataType:"json",success:function(h){if(h.hasOwnProperty("result")&&h.result===true){var i=jQuery(h.data).hide().fadeIn();for(n=0;n<b;n++){if(d){f.prepend(i)}else{f.append(i)}i.css("opacity",0).animate({opacity:1}).find("> td").wrapInner('<div style="display: none;" />').parent().find("> td > div").slideDown(400,function(){var j=jQuery(this);j.replaceWith(j.contents());i.find("[data-col] > *, .flex-column > .hiweb-field-repeat-flex > tbody > tr > [data-col] > *").trigger("init_3")});hiweb_field_repeat.make_table_names(c);i.find("[data-col] > *, .flex-column > .hiweb-field-repeat-flex > tbody > tr > [data-col] > *").trigger("init");if(typeof g==="function"){g(c,i)}}}else{console.warn(h)}},error:function(h){console.warn(h)}})},objectifyForm:function(c){var b={};for(var a=0;a<c.length;a++){b[c[a]["name"]]=c[a]["value"]}return b},click_duplicate:function(f){f.preventDefault();var a=jQuery(this).closest(hiweb_field_repeat.selector);var d=hiweb_field_repeat.get_rows_list(a);var c=jQuery(this).closest(hiweb_field_repeat.selector_row);var b={};hiweb_field_repeat.get_cols(a).each(function(){var e=jQuery(this).attr("data-col");b[e]=hiweb_field_repeat.objectifyForm(c.find('> td[data-col="'+e+'"] [name]').serializeArray())});jQuery.ajax({url:ajaxurl+"?action=hiweb-field-repeat-get-row",type:"post",data:{id:hiweb_field_repeat.get_global_id(this),method:"ajax_html_row",input_name:hiweb_field_repeat.get_name_id(this),value:{}},dataType:"json",success:function(e){if(e.hasOwnProperty("result")&&e.result===true){var g=jQuery(e.data).hide().fadeIn();d.append(g);g.find("[data-col] > *").trigger("init");g.css("opacity",0).animate({opacity:1}).find("> td").wrapInner('<div style="display: none;" />').parent().find("> td > div").slideDown(700,function(){var h=jQuery(this);h.replaceWith(h.contents())});hiweb_field_repeat.make_table_names(a)}else{console.warn(e)}},error:function(e){console.warn(e)}})},click_remove:function(a){a.preventDefault();var b=jQuery(this).closest(hiweb_field_repeat.selector_row);hiweb_field_repeat.do_remove_row(b)},do_remove_row:function(a){return jQuery(a).find("> td").wrapInner('<div style="display: block;" />').parent().find("> td > div").slideUp(700,function(){var b=a.closest(hiweb_field_repeat.selector);jQuery(this).parent().parent().remove();a.remove();hiweb_field_repeat.make_table_names(b);if(hiweb_field_repeat.get_rows(b).length===0){jQuery(b).find(".message").fadeIn()}})},click_clear_full:function(b){b.preventDefault();if(confirm("Remove all table rows?")){var a=jQuery(this).closest(hiweb_field_repeat.selector);hiweb_field_repeat.get_rows(a).each(function(){hiweb_field_repeat.do_remove_row(this)})}}};jQuery(document).ready(hiweb_field_repeat.init_once);jQuery("body").on("init_3",".hiweb-field-repeat",hiweb_field_repeat.init);