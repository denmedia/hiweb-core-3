let hiweb_field_repeat={selector:".hiweb-field-repeat",selector_source:"[data-row-source]",selector_wrap:"tbody.wrap",selector_row:"[data-row]",selector_button_add:"[data-action-add]",selector_button_clear:"[data-action-clear]",selector_button_remove:"[data-action-remove]",selector_button_duplicate:"[data-action-duplicate]",init:function(a){hiweb_field_repeat.make_sortable(a);jQuery(a).find("> table > thead .dropdown, > table > tfoot .dropdown").dropdown({action:"hide"});if(jQuery(a).parent().closest(hiweb_field_repeat.selector).length===0){hiweb_field_repeat.set_input_names(a)}},init_once:function(){jQuery(hiweb_field_repeat.selector).each(function(){hiweb_field_repeat.init(this)});jQuery("body").on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_add,hiweb_field_repeat.click_add).on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_remove,hiweb_field_repeat.click_remove).on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_duplicate,hiweb_field_repeat.click_duplicate).on("click",hiweb_field_repeat.selector+" "+hiweb_field_repeat.selector_button_clear,hiweb_field_repeat.click_clear_full)},get_row_source:function(a){return jQuery(a).find("> table > tbody[data-rows-source] > tr[data-row]")},get_rows_list:function(a){return jQuery(a).find("> table > tbody[data-rows-list]")},get_rows:function(a){return jQuery(a).find("> table > tbody[data-rows-list] > tr[data-row]")},get_cols:function(a){return jQuery(a).find("> table > thead [data-col]")},get_cols_by_row:function(a){return jQuery(a).find("> [data-col], > td > [data-col], > td > table > tbody > tr > [data-col]")},make_sortable:function(a){var b=hiweb_field_repeat.get_rows_list(a);if(typeof b.sortable=="undefined"){alert("Плагин jquery.ui.sortable.js не подключен!");return}if(b.sortable.hasOwnProperty("destroy")){b.sortable("destroy")}b.sortable({update:function(d,c){hiweb_field_repeat.set_input_names(jQuery(this).closest(hiweb_field_repeat.selector));c.placeholder.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-drag-update",[jQuery(this),jQuery(this).closest("[data-row]"),a])})},distance:3,handle:"> [data-drag], > [data-drag] button, > [data-drag] i",helper:function(d,c){c.find("th, td").each(function(){jQuery(this).width(jQuery(this).width())});c.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-dragged",[jQuery(this),jQuery(this).closest("[data-row]"),a])});return c},revert:true,start:function(d,c){c.placeholder.height(c.helper.height());c.helper.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-drag-start",[jQuery(this),jQuery(this).closest("[data-row]"),a])})},stop:function(d,c){c.item.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-drag-stop",[jQuery(this),jQuery(this).closest("[data-row]"),a])})}})},getRandomColor:function(){var c="0123456789ABCDEF";var a="#";for(var b=0;b<6;b++){a+=c[Math.floor(Math.random()*16)]}return a},set_input_names:function(a){a=jQuery(a);a.find("[data-row]").each(function(){jQuery(this).attr("data-row",jQuery(this).index())});var b=a.find("[name]");b.each(function(){jQuery(this).attr("name",hiweb_field_repeat.get_input_name(jQuery(this)))});a.find("> table > tbody[data-rows-message] [data-row-empty]").attr("data-row-empty",hiweb_field_repeat.get_rows(a).length>0?"1":"0")},get_input_name:function(g){g=jQuery(g);var b=[];var c=10;while(c>0){var d=g.closest("[data-col]");if(d.length!==1){return g.closest(".hiweb-field-repeat[data-input-name]").attr("data-input-name")}b.push("["+d.attr("data-col")+"]");var a=d.closest("[data-row]");if(a.length!==1){console.warn("2: row not found");break}b.push("["+a.attr("data-row")+"]");var f=a.closest(".hiweb-field-repeat[data-id]");if(f.length!==1){console.warn("3: repeat not found")}var e=f.closest("[data-col]");if(e.length!==1){b.push(f.attr("data-input-name"));break}else{g=f}c--}return b.reverse().join("")},get_global_id:function(a){return jQuery(a).is("[data-global-id]")?jQuery(a).attr("data-global-id"):jQuery(a).closest("[data-global-id]").attr("data-global-id")},get_name_id:function(a){return jQuery(a).is("[data-input-name]")?jQuery(a).data("input-name"):jQuery(a).closest("[data-input-name]").data("input-name")},click_add:function(f){f.preventDefault();if(jQuery(this).is('[data-action-add="flex-dropdown"]')){var g=jQuery(this).closest("[data-ctrl]").find("[data-sub-flex-dropdown]");var d=null;g.fadeIn().off("mouseover mouseout").on("mouseout",function(){d=setTimeout(function(){g.fadeOut()},1000)}).on("mouseover",function(){clearTimeout(d)})}else{var c=jQuery(this).is('[data-action-add="1"]');var b=jQuery(this).closest(hiweb_field_repeat.selector);var a=jQuery(this).is("[data-flex-id]")?jQuery(this).attr("data-flex-id"):"";if(a!==""){jQuery(this).closest("[data-sub-flex-dropdown]").fadeOut()}hiweb_field_repeat.add_rows(b,c,1,"",a)}},add_rows:function(c,d,b,g,a){if(typeof b==="undefined"){b=1}if(typeof d==="undefined"){d=false}if(typeof a==="undefined"){a=""}var f=hiweb_field_repeat.get_rows_list(c);var e=d?0:hiweb_field_repeat.get_rows(c).length;jQuery.ajax({url:ajaxurl+"?action=hiweb-field-repeat-get-row",type:"post",data:{id:hiweb_field_repeat.get_global_id(c),method:"ajax_html_row",input_name:hiweb_field_repeat.get_name_id(c),index:e,flex_row_id:a},dataType:"json",success:function(h){if(h.hasOwnProperty("result")&&h.result===true){var i=jQuery(h.data).hide().fadeIn();for(n=0;n<b;n++){if(d){f.prepend(i)}else{f.append(i)}i.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-add-new-row",[jQuery(this),i,c])});i.find("> td").wrapInner('<div style="display: none;" />').parent().find("> td > div").slideDown(400,function(){var j=jQuery(this);j.replaceWith(j.contents());i.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-added-row-fadein",[jQuery(this),i,c]);jQuery(this).trigger("hiweb-field-repeat-added-new-row-fadein",[jQuery(this),i,c])})});hiweb_field_repeat.set_input_names(c);i.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-added-row",[jQuery(this),i,c]);jQuery(this).trigger("hiweb-field-repeat-added-new-row",[jQuery(this),i,c])})}}else{console.warn(h)}},error:function(h){console.warn(h)}})},paramsToArray:function(a,f){var e=a.match(/(\[?[\d\w\-\_]+\]?)/g);var d=temp={};for(var c=0;c<e.length;c++){var b=e[c].replace(/^\[?([\d\w\-\_]+)\]?/,"$1");if(c===e.length-1){temp=temp[b]=f}else{temp=temp[b]={}}}return d},click_duplicate:function(g){g.preventDefault();var a=jQuery(this).closest(hiweb_field_repeat.selector);var f=hiweb_field_repeat.get_rows_list(a);var d=jQuery(this).closest(hiweb_field_repeat.selector_row);var b=[];var c=hiweb_field_repeat.get_input_name(this)+"["+d.attr("data-row")+"]";d.find("[name]").each(function(){var e=jQuery(this).attr("name");if(e.indexOf(c)===0){e=e.substr(c.toString().length).replace(/^\[([\w\d\-_]+)\]/g,"$1");b.push(hiweb_field_repeat.paramsToArray(e,jQuery(this).val()))}});jQuery.ajax({url:ajaxurl+"?action=hiweb-field-repeat-get-row",type:"post",data:{id:hiweb_field_repeat.get_global_id(this),method:"ajax_html_row",row_index:d.attr("data-row"),values:deepMerge.all(b)},dataType:"json",success:function(e){if(e.hasOwnProperty("result")&&e.result===true){var h=jQuery(e.data).hide().fadeIn();d.after(h);h.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-add-new-row",[jQuery(this),h,a])});h.css("opacity",0).animate({opacity:1}).find("> td").wrapInner('<div style="display: none;" />').parent().find("> td > div").slideDown(700,function(){var i=jQuery(this);i.replaceWith(i.contents());h.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-cloned-row-fadein",[jQuery(this),h,a]);jQuery(this).trigger("hiweb-field-repeat-added-new-row-fadein",[jQuery(this),h,a])})});hiweb_field_repeat.set_input_names(a);h.find("[data-col]").each(function(){jQuery(this).trigger("hiweb-field-repeat-cloned-row",[jQuery(this),h,a]);jQuery(this).trigger("hiweb-field-repeat-added-new-row",[jQuery(this),h,a])})}else{console.warn(e)}},error:function(e){console.warn(e)}})},click_remove:function(a){a.preventDefault();var b=jQuery(this).closest(hiweb_field_repeat.selector_row);hiweb_field_repeat.do_remove_row(b)},do_remove_row:function(a){return jQuery(a).find("> td").wrapInner('<div style="display: block;" />').parent().find("> td > div").slideUp(700,function(){var b=a.closest(hiweb_field_repeat.selector);jQuery(this).parent().parent().remove();a.remove();hiweb_field_repeat.set_input_names(b);if(hiweb_field_repeat.get_rows(b).length===0){jQuery(b).find(".message").fadeIn()}})},click_clear_full:function(b){b.preventDefault();if(confirm("Remove all table rows?")){var a=jQuery(this).closest(hiweb_field_repeat.selector);hiweb_field_repeat.get_rows(a).each(function(){hiweb_field_repeat.do_remove_row(this)})}}};jQuery(document).ready(hiweb_field_repeat.init_once);jQuery("body").on("hiweb-field-repeat-added-new-row","[data-col]",function(c,b,d,a){b.find(".hiweb-field-repeat").each(function(){hiweb_field_repeat.init(this)})});